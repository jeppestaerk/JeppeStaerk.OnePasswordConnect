name: Build and Publish

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# Prevent multiple deployments running concurrently
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

env:
  PROJECT_PATH: 'src/JeppeStaerk.OnePasswordConnect.Sdk/JeppeStaerk.OnePasswordConnect.Sdk.csproj'
  DOTNET_VERSION: '10.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  build-test-package:
    name: Build, Test and Package
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
      pull-requests: write
      id-token: write
      attestations: write
    outputs:
      version: ${{ steps.package-version.outputs.version }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json', '**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Restore dependencies
      run: dotnet restore JeppeStaerk.OnePasswordConnect.sln

    - name: Build
      run: |
        dotnet build JeppeStaerk.OnePasswordConnect.sln \
          --configuration Release \
          --no-restore \
          -p:RepositoryBranch=${{ github.ref_name }} \
          -p:RepositoryCommit=${{ github.sha }} \
          -p:ContinuousIntegrationBuild=true

    - name: Test
      run: |
        dotnet test JeppeStaerk.OnePasswordConnect.sln \
          --configuration Release \
          --no-build \
          --verbosity normal \
          --logger "trx;LogFileName=test-results.trx" \
          --results-directory ./test-results

    - name: Publish test results
      uses: EnricoMi/publish-unit-test-result-action@v2
      if: always()
      with:
        files: 'test-results/**/*.trx'
        check_name: 'Test Results'

    - name: Pack
      if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
      run: |
        dotnet pack ${{ env.PROJECT_PATH }} \
          --configuration Release \
          --no-build \
          --output ./artifacts \
          -p:RepositoryBranch=${{ github.ref_name }} \
          -p:RepositoryCommit=${{ github.sha }} \
          -p:ContinuousIntegrationBuild=true

    - name: Extract package version
      if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
      id: package-version
      run: |
        PACKAGE_FILE=$(ls ./artifacts/*.nupkg | head -n 1)
        VERSION=$(basename "$PACKAGE_FILE" | sed 's/.*\.\([0-9]\+\.[0-9]\+\.[0-9]\+.*\)\.nupkg/\1/')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Package version: $VERSION"

    - name: Install Cosign
      if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
      uses: sigstore/cosign-installer@v4.0.0

    - name: Sign packages with Sigstore
      if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
      run: |
        for package in ./artifacts/*.nupkg; do
          echo "Signing $(basename "$package")..."
          cosign sign-blob "$package" \
            --bundle "${package}.cosign.bundle" \
            --yes
          echo "✓ Signed with Sigstore"
        done

        echo ""
        echo "Verifying bundle files:"
        ls -lh ./artifacts/*.cosign.bundle 2>/dev/null || echo "⚠️ No bundle files found!"
        echo ""
        echo "All files in artifacts:"
        ls -lh ./artifacts/

    - name: Generate SLSA attestation
      uses: actions/attest-build-provenance@v3
      if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
      with:
        subject-path: './artifacts/*.nupkg'

    - name: Upload build artifacts
      uses: actions/upload-artifact@v5
      if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
      with:
        name: nuget-packages
        path: |
          ./artifacts/*.nupkg
          ./artifacts/*.cosign.bundle
        retention-days: 7
        if-no-files-found: error

  publish-nuget:
    name: Publish to NuGet.org
    runs-on: ubuntu-latest
    needs: build-test-package
    if: startsWith(github.ref, 'refs/tags/v')
    environment:
      name: nuget-org
      url: https://www.nuget.org/packages/JeppeStaerk.OnePasswordConnect.Sdk
    permissions:
      contents: write

    steps:
    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Download artifacts
      uses: actions/download-artifact@v6
      with:
        name: nuget-packages
        path: ./artifacts

    - name: Publish to NuGet.org
      run: |
        dotnet nuget push ./artifacts/*.nupkg \
          --api-key ${{ secrets.NUGET_API_KEY }} \
          --source https://api.nuget.org/v3/index.json \
          --skip-duplicate

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          ./artifacts/*.nupkg
          ./artifacts/*.cosign.bundle
        generate_release_notes: true
        fail_on_unmatched_files: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-github:
    name: Publish to GitHub Packages
    runs-on: ubuntu-latest
    needs: build-test-package
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: github-packages
      url: https://github.com/jeppestaerk/JeppeStaerk.OnePasswordConnect/pkgs/nuget/JeppeStaerk.OnePasswordConnect.Sdk
    permissions:
      packages: write
      id-token: write
      contents: read

    steps:
    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Download artifacts
      uses: actions/download-artifact@v6
      with:
        name: nuget-packages
        path: ./artifacts

    - name: Authenticate to GitHub Packages
      run: |
        dotnet nuget add source \
          --username ${{ github.actor }} \
          --password ${{ secrets.GITHUB_TOKEN }} \
          --store-password-in-clear-text \
          --name github \
          "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json"

    - name: Publish to GitHub Packages
      run: |
        dotnet nuget push ./artifacts/*.nupkg \
          --source github \
          --skip-duplicate
